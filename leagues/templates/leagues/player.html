{% extends 'core/base.html' %}
{% load static %}
{% load helpers %}
{% block extra_head %}
<style>
    .stat-breakdown-note {
        font-size: 0.95em;
        color: #666;
        margin: 10px 0 20px;
    }
    .stat-scope-header .stat-breakdown-note {
        margin: 0;
    }
    .stat-block {
        margin-bottom: 24px;
    }
    .stat-block-title {
        margin-bottom: 10px;
    }
    .table-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .table-scroll .table {
        min-width: 520px;
    }
    @media screen and (max-width: 736px) {
        .table-scroll .table {
            min-width: 480px;
        }
    }
</style>
{% endblock %}
{% block content %}
<div id="content-wrapper" class="team">
    <div id="content">
        <div class="container">
            <div class="row">
                <div class="8u 12u(mobile)">
                    {% if player %}
                    <div class="title">
                        {{ player.first_name }} {{ player.last_name }}
                    </div>
                    {% if career_stats %}
                        <h2> Career Goals: {{ career_stats.career_goals }} Career Assists: {{ career_stats.career_assists }} </h2>
                        {% if seasons %} <h3>Seasons Played since {{ career_stats.first_season }}: {{ seasons|floatformat:0 }} </h3> {% endif %}
                        <h3 class="stat-scope-target" data-scope="combined">
                            Average Goals/Season: {{ average_stats.combined.average_goals_per_season|default:0|floatformat:2 }} &nbsp;
                            Average Assists/Season: {{ average_stats.combined.average_assists_per_season|default:0|floatformat:2 }}
                        </h3>
                        <h3 class="stat-scope-target hidden" data-scope="regular">
                            Regular Season Average Goals/Season: {{ average_stats.regular.average_goals_per_season|default:0|floatformat:2 }} &nbsp;
                            Regular Season Average Assists/Season: {{ average_stats.regular.average_assists_per_season|default:0|floatformat:2 }}
                        </h3>
                        <h3 class="stat-scope-target hidden" data-scope="postseason">
                            Post Season Average Goals/Season: {{ average_stats.postseason.average_goals_per_season|default:0|floatformat:2 }} &nbsp;
                            Post Season Average Assists/Season: {{ average_stats.postseason.average_assists_per_season|default:0|floatformat:2 }}
                        </h3>
                    {% endif %}
                    {% endif %}
                </div>
                <div class="4u 12u(mobile)">
                    {% if offensive_stats %}
                    <h3>Player Trends Snapshot</h3>
                    <canvas id="playerTrendsSnapshot" style="cursor: pointer;" onclick="window.location.href='{% url 'player_trends' %}?player_id={{ player.id }}'"></canvas>
                    {% endif %}
                </div>
            </div>
            <section class="rostersection">
                <div class="stat-scope-header">
                    <div class="stat-breakdown-note">
                        Stats view: Combined (default), Regular Season, or Post Season.
                    </div>
                    <div class="stat-scope-toggle fancy">
                        <div class="optionsdiv stat-scope-option activeoption" onclick="showStatScope('combined', this)">
                            Combined
                        </div>
                        <div class="optionsdiv stat-scope-option" onclick="showStatScope('regular', this)">
                            Regular Season
                        </div>
                        <div class="optionsdiv stat-scope-option" onclick="showStatScope('postseason', this)">
                            Post Season
                        </div>
                    </div>
                </div>
                {% if goalie_stats %}
                    <h2> Career Goals Against Average: {{ career_stats.average_goals_against_per_game|floatformat:2 }} </h2>
                {% endif %}
                {% for section in stat_sections %}
                <section class="rostersection stat-block stat-scope-target {% if section.key != "combined" %}hidden{% endif %}" data-scope="{{ section.key }}" id="stats-{{ section.key }}">
                    <h3 class="stat-block-title">{{ section.label }}</h3>
                    <div class="row player_stats">
                        <div class="12u 12u(mobile)">
                            <div class="table-scroll">
                                <table class="table">
                                    <tr>
                                        <th class="stat-column">Year</th>
                                        <th class="stat-column">Season</th>
                                        <th class="stat-column">Team (Record)</th>
                                        <th class="stat-column">Div</th>
                                        <th class="stat-column">Goals</th>
                                        <th class="stat-column">Assists</th>
                                        <th class="stat-column">Pts</th>
                                    </tr>
                                    {% if section.offensive_stats %}
                                    {% for stat in section.offensive_stats %}
                                    <tr>
                                        <td>{{ stat.team__season__year }}</td>
                                        <td>{{ stat.team__season__season_type|season_type }}</td>
                                        <td class="clickable" onclick="javascript:handleTeam('{% url "teams" stat.team__id %}')">
                                            {% if stat.team__season__year < 2022 %}
                                                {{ stat.team__team_name }} ({{ stat.team_wins|default:0 }} - {{ stat.team_losses|default:0 }} - {{ stat.team_ties|default:0 }})
                                            {% else %}
                                                {{ stat.team__team_name }} ({{ stat.team_wins|default:0 }} - {{ stat.team_otw|default:0 }} - {{ stat.team_otl|default:0 }} - {{ stat.team_losses|default:0 }})
                                            {% endif %}
                                        </td>
                                        <td>{{ stat.team__division|division_type }}</td>
                                        <td>{{ stat.sum_goals|default:0 }}</td>
                                        <td>{{ stat.sum_assists|default:0 }}</td>
                                        <td>{{ stat.sum_goals|add:stat.sum_assists|default:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="7">No offensive stats available.</td>
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="row player_stats">
                        <div class="12u 12u(mobile)">
                            <div class="table-scroll">
                                <table class="table">
                                    <tr>
                                        <th class="stat-column">Year</th>
                                        <th class="stat-column">Season</th>
                                        <th class="stat-column">Team Name (Record)</th>
                                        <th class="stat-column">Div</th>
                                        <th class="stat-column">GAA</th>
                                        <th class="stat-column">GP</th>
                                        <th class="stat-column">GA</th>
                                    </tr>
                                    {% if section.goalie_stats %}
                                    {% for stat in section.goalie_stats %}
                                    <tr>
                                        <td>{{ stat.team__season__year }}</td>
                                        <td>{{ stat.team__season__season_type|season_type }}</td>
                                        <td class="clickable" onclick="javascript:handleTeam('{% url "teams" stat.team__id %}')">
                                            {% if stat.team__season__year < 2022 %}
                                                {{ stat.team__team_name }} ({{ stat.team_wins|default:0 }} - {{ stat.team_losses|default:0 }} - {{ stat.team_ties|default:0 }})
                                            {% else %}
                                                {{ stat.team__team_name }} ({{ stat.team_wins|default:0 }} - {{ stat.team_otw|default:0 }} - {{ stat.team_otl|default:0 }} - {{ stat.team_losses|default:0 }})
                                            {% endif %}
                                        </td>
                                        <td>{{ stat.team__division|division_type }}</td>
                                        <td>{{ stat.average_goals_against|floatformat:2 }}</td>
                                        <td>{{ stat.sum_games_played|default:0 }}</td>
                                        <td>{{ stat.sum_goals_against|default:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="7">No goalie stats available.</td>
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                {% endfor %}
            </section>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% if offensive_stats %}
<script>
    function showStatScope(scope, element) {
        var sections = document.querySelectorAll('.stat-scope-target');
        sections.forEach(function(section) {
            if (section.dataset.scope === scope) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        });
        var options = document.querySelectorAll('.stat-scope-toggle .optionsdiv');
        options.forEach(function(option) {
            option.classList.remove('activeoption');
        });
        element.classList.add('activeoption');
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("JavaScript loaded");

        console.log("Player Seasons: ", {{ player_seasons|safe }});
        console.log("Player Goals: ", {{ player_goals|safe }});
        console.log("Player Assists: ", {{ player_assists|safe }});
        console.log("Trend Line: ", {{ trend_line|safe }});

        var ctx = document.getElementById('playerTrendsSnapshot').getContext('2d');
        var playerTrendsSnapshot = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ player_seasons|safe }}, // List of seasons
                datasets: [
                    {
                        label: 'Goals',
                        data: {{ player_goals|safe }}, // List of goals per season
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false
                    },
                    {
                        label: 'Assists',
                        data: {{ player_assists|safe }}, // List of assists per season
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false
                    },
                    {
                        label: 'Point Trend',
                        data: {{ trend_line|safe }}, // Trend line for total points
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        fill: false,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true, // Ensure the aspect ratio is maintained
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Season'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.length > 10 ? value.substr(0, 10) + '...' : value;
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Count'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}
